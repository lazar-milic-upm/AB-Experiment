<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Survey AB Experiment</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <h2>Quick Survey</h2>
        <form id="surveyForm">
            <div class="question-block">
                <p>How likely are you to click a button like this in real life?</p>
                <div class="radio-group">
                    <label><input type="radio" name="likelihood" value="1" required> 1</label>
                    <label><input type="radio" name="likelihood" value="2"> 2</label>
                    <label><input type="radio" name="likelihood" value="3"> 3</label>
                    <label><input type="radio" name="likelihood" value="4"> 4</label>
                    <label><input type="radio" name="likelihood" value="5"> 5</label>
                </div>
            </div>
            <div class="question-block">
                <p>How visually appealing was the button?</p>
                <div class="radio-group">
                    <label><input type="radio" name="appeal" value="1" required> 1</label>
                    <label><input type="radio" name="appeal" value="2"> 2</label>
                    <label><input type="radio" name="appeal" value="3"> 3</label>
                    <label><input type="radio" name="appeal" value="4"> 4</label>
                    <label><input type="radio" name="appeal" value="5"> 5</label>
                </div>
            </div>
            <button class="submitFormButton" id="submitFormButton" type="submit" form="surveyForm">Submit</button>
        </form>
        <!-- ACTION BUTTONS AFTER SUBMIT  -->
        <div id="afterSubmit" style="display:none; margin-top:30px; text-align:center;">
            <button class="button" style="background-color: green; color: white; margin-bottom: 10px;" onclick="location.href='index.html'">Return Home</button>
            <button class="button" style="background-color: #007BFF; color: white; margin-bottom: 10px;" onclick="window.open('https://ab-experiment.onrender.com/download-db','_blank')">Download DB - Sqlite format</button>
            <button class="button" style="background-color: #007BFF; color: white; margin-bottom: 10px;" onclick="window.open('https://ab-experiment.onrender.com/export/json','_blank')">Download DB - JSON format</button>
            <button class="button" style="background-color: darkred; color: white; margin-bottom: 10px;" onclick="clearDB()">Clear&nbsp;DB</button>
        </div>
        <script>
            const data = JSON.parse(localStorage.getItem('ab_click_data'));

            /* console log session info */
            if (data) {
              console.log('[A/B data]', {
                ...data,
                timestamp: new Date(data.timestamp).toLocaleString()
              });
            }

            /* handle submit */
            document.getElementById('surveyForm').addEventListener('submit', e => {
              e.preventDefault();

              const likelihood = +document.querySelector('input[name="likelihood"]:checked').value;
              const appeal     = +document.querySelector('input[name="appeal"]:checked').value;

              const payload = { ...data, likelihood, appeal };

              fetch('https://ab-experiment.onrender.com/submit', {
                method : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body   : JSON.stringify(payload)
              })
              .then(() => {
                alert(
                  `You chose:\ \n \n • Likelihood ${likelihood}\ \n • Appeal ${appeal}`
                );

                /* Disable the survey */
                document.querySelectorAll('#surveyForm input, #surveyForm #submitFormButton')
                        .forEach(el => el.disabled = true);

                document.getElementById('submitFormButton').classList.add('disabled');

                /* Reveal action buttons */
                document.getElementById('afterSubmit').style.display = 'block';

                localStorage.removeItem('ab_click_data');
              })
              .catch(() => alert('Error submitting your response.'));
            });

            // ——— clear-database helper with confirmation ———
            function clearDB() {
                if (!confirm('This will delete ALL rows in the database. Continue?')) return;

                fetch('https://ab-experiment.onrender.com/clear-db', { method: 'POST' })
                  .then(() => alert('Database cleared.'))
                  .catch(() => alert('Failed to clear DB'));
            }
        </script>
    </body>
</html>
